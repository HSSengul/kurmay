rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ========== HELPERS ========== */

    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function userData(uid) {
      return userDoc(uid).data;
    }

    function isUserBanned(uid) {
      return exists(/databases/$(database)/documents/users/$(uid))
        && (
          (
            ("banStatus" in userData(uid))
            && userData(uid).banStatus == "permanent"
          )
          || (
            ("banStatus" in userData(uid))
            && userData(uid).banStatus == "temporary"
            && ("banUntil" in userData(uid))
            && (userData(uid).banUntil is timestamp)
            && userData(uid).banUntil > request.time
          )
        );
    }

    function isUserBlockedListings(uid) {
      return exists(/databases/$(database)/documents/users/$(uid))
        && ("blockListings" in userData(uid))
        && userData(uid).blockListings == true;
    }

    function isUserBlockedMessages(uid) {
      return exists(/databases/$(database)/documents/users/$(uid))
        && ("blockMessages" in userData(uid))
        && userData(uid).blockMessages == true;
    }

    function nonEmptyString(v, max) {
      return v is string && v.size() > 0 && v.size() <= max;
    }

    function validImageUrl(v) {
      return v is string && v.size() > 0 && v.size() <= 2000;
    }

    function validImages(arr) {
      return (arr is list)
        && (arr.size() >= 1)
        && (arr.size() <= 5)
        && validImageUrl(arr[0])
        && (arr.size() < 2 || validImageUrl(arr[1]))
        && (arr.size() < 3 || validImageUrl(arr[2]))
        && (arr.size() < 4 || validImageUrl(arr[3]))
        && (arr.size() < 5 || validImageUrl(arr[4]));
    }

    // âœ… NEW: optional string helper ("" olabilir)
    function optionalString(v, max) {
      return (v is string) && (v.size() <= max);
    }

    // âœ… NEW: public profile PII guard (only store if explicitly public)
    function isPublicPhoneAllowed(data) {
      return !("phone" in data)
        || (data.phone == "")
        || (
          (data.phone is string)
          && data.phone.size() <= 20
          && data.showPhone == true
        );
    }

    function isPublicAddressAllowed(data) {
      return !("address" in data)
        || (data.address == "")
        || (
          (data.address is string)
          && data.address.size() <= 200
          && data.showAddress == true
        );
    }

    function isPublicWebsiteAllowed(data) {
      return !("websiteInstagram" in data)
        || (data.websiteInstagram == "")
        || (
          (data.websiteInstagram is string)
          && data.websiteInstagram.size() <= 200
          && data.showWebsiteInstagram == true
        );
    }

    function isPublicProfileSafe(data) {
      return isPublicPhoneAllowed(data)
        && isPublicAddressAllowed(data)
        && isPublicWebsiteAllowed(data);
    }

    // ðŸ”’ Onboarding tamam mÄ±?
    function onboardingCompleted() {
      return exists(/databases/$(database)/documents/publicProfiles/$(request.auth.uid))
        && get(/databases/$(database)/documents/publicProfiles/$(request.auth.uid)).data.onboardingCompleted == true;
    }

    /* ====== CHAT HELPERS (CONVERSATIONS / MESSAGES) ====== */

    function listingDoc(listingId) {
      return get(/databases/$(database)/documents/listings/$(listingId));
    }

    function listingExists(listingId) {
      return exists(/databases/$(database)/documents/listings/$(listingId));
    }

    function isParticipantByResource() {
      return signedIn()
        && (resource.data.participants is list)
        && (request.auth.uid in resource.data.participants);
    }

    function isValidUnreadMap(m) {
      return (m is map)
        && (m.buyer is int || m.buyer is number)
        && (m.seller is int || m.seller is number)
        && (m.buyer >= 0)
        && (m.seller >= 0);
    }

    function isValidDeletedForMap(m) {
      return (m is map)
        && (m.buyer is bool)
        && (m.seller is bool);
    }

    function isValidStatus(v) {
      return (v is string)
        && (v in ["active", "archivedByBuyer", "archivedBySeller"]);
    }

    function hasValidParticipantsArray(arr, buyerId, sellerId) {
      return (arr is list)
        && (arr.size() == 2)
        && (buyerId in arr)
        && (sellerId in arr);
    }

    function isValidListingSnapshot(s) {
      // Snapshot alanlarÄ±: null'lara izin veriyoruz (Ã¶rn imageUrl)
      return (s is map)
        && (s.title is string)
        && (s.title.size() <= 200)
        && (s.price is number)
        && (s.price >= 0)
        && (s.categoryName is string)
        && (s.categoryName.size() <= 120)
        && (s.subCategoryName is string)
        && (s.subCategoryName.size() <= 120)
        && (
          // imageUrl hiÃ§ yoksa da olur
          !("imageUrl" in s)
          || (s.imageUrl == null)
          || (s.imageUrl is string)
        );
    }

    function isValidSellerSnapshot(s) {
      return (s is map)
        && nonEmptyString(s.publicProfileId, 256)
        && nonEmptyString(s.displayName, 120);
    }

    function isValidBuyerSnapshot(s) {
      return (s is map)
        && nonEmptyString(s.displayName, 120);
    }

    function isValidLastMessageMap(m) {
      // lastMessage varsa doÄŸrula
      return (m is map)
        && (m.type is string)
        && (m.type in ["text","image","system"])
        && (m.senderId is string)
        && (m.senderId.size() > 0)
        && (m.createdAt is timestamp)
        && (
          // text ise text dolu olmalÄ±
          (m.type == "text" && nonEmptyString(m.text, 2000))
          ||
          // image ise text opsiyonel olabilir (yok veya kÄ±sa)
          (m.type == "image" && (!("text" in m) || (m.text is string && m.text.size() <= 500)))
          ||
          // system ise text kÄ±sa olabilir
          (m.type == "system" && ("text" in m) && (m.text is string) && (m.text.size() <= 500))
        );
    }

    function isValidLastMessageField(data) {
      // lastMessage opsiyonel
      return !("lastMessage" in data) || isValidLastMessageMap(data.lastMessage);
    }

    function isValidLastReadAtMap(m) {
      // - yoksa / null ise OK
      // - varsa map olmalÄ±
      // - buyer/seller varsa timestamp olmalÄ±
      return (m == null) || (
        (m is map)
        && ( !("buyer" in m) || (m.buyer is timestamp) )
        && ( !("seller" in m) || (m.seller is timestamp) )
      );
    }

    // âœ… NEW: clearedAt validator (soft delete)
    function isValidClearedAtMap(m) {
      return (m == null) || (
        (m is map)
        && ( !("buyer" in m) || (m.buyer == null) || (m.buyer is timestamp) )
        && ( !("seller" in m) || (m.seller == null) || (m.seller is timestamp) )
      );
    }

    // âœ… NEW: clearedCount validator (silme anÄ±ndaki totalMessages snapshot)
    function isValidClearedCountMap(m) {
      return (m == null) || (
        (m is map)
        && (
          !("buyer" in m)
          || (
            (m.buyer is int || m.buyer is number)
            && (m.buyer >= 0)
          )
        )
        && (
          !("seller" in m)
          || (
            (m.seller is int || m.seller is number)
            && (m.seller >= 0)
          )
        )
      );
    }

    // ðŸ”¥ YENÄ°: Typing map validator
    function isValidTypingMap(m) {
      // typing yoksa da olur; varsa buyer/seller bool, updatedAt timestamp olabilir
      return (m == null) || (
        (m is map)
        && ( !("buyer" in m) || (m.buyer is bool) )
        && ( !("seller" in m) || (m.seller is bool) )
        && ( !("updatedAt" in m) || (m.updatedAt is timestamp) )
      );
    }

    function isValidMessageCreate(msg, convo) {
      // type: text / image (system'i client tarafÄ±nda ÅŸimdilik kapatÄ±yoruz; isAdmin ile aÃ§Ä±labilir)
      return (msg.type is string)
        && !isUserBanned(request.auth.uid)
        && !isUserBlockedMessages(request.auth.uid)
        && (
          msg.type == "text"
          || msg.type == "image"
          || (msg.type == "system" && isAdmin())
        )
        && (msg.senderId == request.auth.uid)
        && (request.auth.uid in convo.data.participants)
        && (msg.createdAt is timestamp)
        && (
          // TEXT
          (msg.type == "text"
            && nonEmptyString(msg.text, 2000)
            && !( "imageUrl" in msg )
            && !( "thumbnailUrl" in msg )
          )
          ||
          // IMAGE (text yok ya da kÄ±sa olabilir)
          (msg.type == "image"
            && (
              !("text" in msg)
              || (msg.text is string && msg.text.size() <= 500)
            )
          )
          ||
          // SYSTEM (admin)
          (msg.type == "system"
            && isAdmin()
            && (msg.text is string)
            && msg.text.size() <= 500
          )
        )
        && (
          // imageUrl / thumbnailUrl kontrolÃ¼ (image ise olmalÄ±)
          (msg.type != "image")
          ||
          (
            ("imageUrl" in msg) && (msg.imageUrl is string) && msg.imageUrl.size() <= 2000
            && ( !("thumbnailUrl" in msg) || (msg.thumbnailUrl is string && msg.thumbnailUrl.size() <= 2000) )
          )
        )
        && (
          // deleted opsiyonel, create anÄ±nda false/olmamasÄ± tercih
          !("deleted" in msg) || msg.deleted is bool
        )
        && (
          // readAt opsiyonel; create anÄ±nda yok veya map olabilir
          !("readAt" in msg) || (msg.readAt is map)
        )
        && (
          // moderation opsiyonel; sadece admin set edebilsin
          !("moderation" in msg) || isAdmin()
        );
    }

    /* ========== LISTINGS ========== */

    match /listings/{id} {

      allow read: if true;

      // âž• Ä°lan oluÅŸturma: sadece onboarding tamamlayan kullanÄ±cÄ±
      allow create: if signedIn()
        && onboardingCompleted()
        && !isUserBanned(request.auth.uid)
        && !isUserBlockedListings(request.auth.uid)
        && request.resource.data.ownerId == request.auth.uid
        && nonEmptyString(request.resource.data.title, 120)
        && request.resource.data.price is number
        && request.resource.data.price >= 0
        && nonEmptyString(request.resource.data.categoryId, 128)
        && nonEmptyString(request.resource.data.subCategoryId, 128)
        && nonEmptyString(request.resource.data.categoryName, 120)
        && nonEmptyString(request.resource.data.subCategoryName, 120)
        && validImages(request.resource.data.imageUrls);

      // âœï¸ Ä°lan gÃ¼ncelleme: admin veya sahibinin kendisi
      allow update: if (
        isAdmin()
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            "adminStatus",
            "adminNote",
            "adminReviewedAt",
            "adminReviewedBy"
          ])
      ) || (
        signedIn()
        && onboardingCompleted()
        && !isUserBanned(request.auth.uid)
        && !isUserBlockedListings(request.auth.uid)
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.categoryId == resource.data.categoryId
        && request.resource.data.subCategoryId == resource.data.subCategoryId
        && request.resource.data.createdAt == resource.data.createdAt
        && nonEmptyString(request.resource.data.title, 120)
        && request.resource.data.price is number
        && request.resource.data.price >= 0
        && validImages(request.resource.data.imageUrls)
      );

      allow delete: if signedIn()
        && resource.data.ownerId == request.auth.uid;
    }

    /* ========== USERS (PRIVATE) ========== */

    match /users/{uid} {

      // KullanÄ±cÄ± sadece kendi belgesini okuyabilir ve oluÅŸturabilir
      allow read, create: if signedIn() && (request.auth.uid == uid || isAdmin());

      // Role deÄŸiÅŸtirilemez (admin escalation engeli)
      allow update: if isAdmin() || (
        signedIn()
        && request.auth.uid == uid
        && request.resource.data.role == resource.data.role
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["email", "provider", "updatedAt"])
      );

      // ðŸ”¥ Firebase SDK'nin aggregate (count) sorgularÄ± iÃ§in
      allow list: if isAdmin();

      allow delete: if false;
    }

    /* ========== PUBLIC PROFILES ========== */

    match /publicProfiles/{uid} {
      allow read: if true;

      allow create, update: if (
        (signedIn() && request.auth.uid == uid) || isAdmin()
      ) && isPublicProfileSafe(request.resource.data);

      allow delete: if signedIn() && request.auth.uid == uid;
    }

    /* ============================================================
       âœ… NEW: PRIVATE PROFILES (phone + address gizli)
       - sadece sahibi + admin okuyabilir
       - sadece sahibi yazabilir
    ============================================================ */

    match /privateProfiles/{uid} {

      allow read: if signedIn()
        && (request.auth.uid == uid || isAdmin());

      allow create: if signedIn()
        && (request.auth.uid == uid || isAdmin())
        && optionalString(request.resource.data.phone, 20)
        && optionalString(request.resource.data.address, 200)
        && optionalString(request.resource.data.websiteInstagram, 200)
        && ( !("createdAt" in request.resource.data) || (request.resource.data.createdAt is timestamp) )
        && ( !("updatedAt" in request.resource.data) || (request.resource.data.updatedAt is timestamp) );

      allow update: if signedIn()
        && (request.auth.uid == uid || isAdmin())
        && optionalString(request.resource.data.phone, 20)
        && optionalString(request.resource.data.address, 200)
        && optionalString(request.resource.data.websiteInstagram, 200)
        && ( !("createdAt" in request.resource.data) || (request.resource.data.createdAt is timestamp) )
        && ( !("updatedAt" in request.resource.data) || (request.resource.data.updatedAt is timestamp) )
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["phone", "address", "websiteInstagram", "createdAt", "updatedAt"]);

      allow delete: if false;
    }

    /* ============================================================
       âœ… NEW: PUBLIC CONTACTS (izin verilmiÅŸ iletiÅŸim)
       - sadece giriÅŸ yapanlar okuyabilir (scrape zor)
       - sadece sahibi yazabilir
    ============================================================ */

    match /publicContacts/{uid} {

      allow read: if signedIn();

      allow create: if signedIn()
        && (request.auth.uid == uid || isAdmin())
        && optionalString(request.resource.data.phone, 20)
        && (request.resource.data.phone == "" || request.resource.data.phone.matches("^[0-9]{10,15}$"))
        && optionalString(request.resource.data.email, 320)
        && optionalString(request.resource.data.address, 200)
        && ( !("updatedAt" in request.resource.data) || (request.resource.data.updatedAt is timestamp) )
        && ( !("createdAt" in request.resource.data) || (request.resource.data.createdAt is timestamp) );

      allow update: if signedIn()
        && (request.auth.uid == uid || isAdmin())
        && optionalString(request.resource.data.phone, 20)
        && (request.resource.data.phone == "" || request.resource.data.phone.matches("^[0-9]{10,15}$"))
        && optionalString(request.resource.data.email, 320)
        && optionalString(request.resource.data.address, 200)
        && ( !("updatedAt" in request.resource.data) || (request.resource.data.updatedAt is timestamp) )
        && ( !("createdAt" in request.resource.data) || (request.resource.data.createdAt is timestamp) )
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(["phone", "email", "address", "createdAt", "updatedAt"]);

      allow delete: if false;
    }

    /* ========== BRANDS ========== */

    match /categories/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ========== MODELS ========== */

    match /subCategories/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ========== LISTING SCHEMAS ========== */

    match /listingSchemas/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ============================================================
       âœ… NEW: ADMIN PANEL COLLECTIONS (YOL B: stats + autoFlags)
       (DiÄŸer kurallara dokunmadÄ±m, sadece bunlarÄ± ekledim)
    ============================================================ */

    match /adminStats/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /adminStatsDaily/{dateKey} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /autoFlags/{flagId} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /adminSettings/{docId} {
      allow read, write: if isAdmin();
    }

    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update, delete: if isAdmin();
    }

    /* ========== CONVERSATIONS (CHAT) ========== */

    match /conversations/{conversationId} {

      allow read: if isAdmin() || (
        signedIn()
        && (resource.data.participants is list)
        && (request.auth.uid in resource.data.participants)
      );

      allow list: if isAdmin() || signedIn();

      // KonuÅŸma oluÅŸturma
      allow create: if signedIn()
        && !isUserBanned(request.auth.uid)
        && !isUserBlockedMessages(request.auth.uid)
        && nonEmptyString(request.resource.data.listingId, 256)
        && nonEmptyString(request.resource.data.buyerId, 256)
        && nonEmptyString(request.resource.data.sellerId, 256)
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.buyerId != request.resource.data.sellerId
        && hasValidParticipantsArray(
          request.resource.data.participants,
          request.resource.data.buyerId,
          request.resource.data.sellerId
        )
        && listingExists(request.resource.data.listingId)
        && listingDoc(request.resource.data.listingId).data.ownerId == request.resource.data.sellerId
        && request.resource.data.createdAt is timestamp
        && request.resource.data.lastMessageAt is timestamp
        && isValidUnreadMap(request.resource.data.unread)
        && isValidDeletedForMap(request.resource.data.deletedFor)
        && isValidStatus(request.resource.data.status)
        && isValidListingSnapshot(request.resource.data.listingSnapshot)
        && isValidSellerSnapshot(request.resource.data.sellerSnapshot)
        && isValidBuyerSnapshot(request.resource.data.buyerSnapshot)
        && isValidLastMessageField(request.resource.data)
        && isValidLastReadAtMap(request.resource.data.lastReadAt)
        && isValidTypingMap(request.resource.data.typing)
        && (!("clearedAt" in request.resource.data) || isValidClearedAtMap(request.resource.data.clearedAt))
        && (!("clearedCount" in request.resource.data) || isValidClearedCountMap(request.resource.data.clearedCount));

      // Update
      allow update: if isParticipantByResource()
        && request.resource.data.listingId == resource.data.listingId
        && request.resource.data.buyerId == resource.data.buyerId
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.participants == resource.data.participants
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.listingSnapshot == resource.data.listingSnapshot
        && request.resource.data.sellerSnapshot == resource.data.sellerSnapshot
        && request.resource.data.buyerSnapshot == resource.data.buyerSnapshot
        && isValidUnreadMap(request.resource.data.unread)
        && isValidDeletedForMap(request.resource.data.deletedFor)
        && isValidStatus(request.resource.data.status)
        && isValidLastMessageField(request.resource.data)
        && request.resource.data.lastMessageAt is timestamp
        && isValidLastReadAtMap(request.resource.data.lastReadAt)
        && isValidTypingMap(request.resource.data.typing)
        && (!("clearedAt" in request.resource.data) || isValidClearedAtMap(request.resource.data.clearedAt))
        && (!("clearedCount" in request.resource.data) || isValidClearedCountMap(request.resource.data.clearedCount))
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            "unread",
            "lastMessage",
            "lastMessageAt",
            "deletedFor",
            "status",
            "lastReadAt",
            "typing",
            "totalMessages",
            "clearedAt",
            "clearedCount"
          ]);

      allow delete: if false;

      /* ========== MESSAGES (SUBCOLLECTION) ========== */

      match /messages/{messageId} {

        // Okuma / listeleme
        allow read, list: if isAdmin() || (
          signedIn()
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
        );

        // Mesaj oluÅŸturma
        allow create: if signedIn()
          && isValidMessageCreate(
            request.resource.data,
            get(/databases/$(database)/documents/conversations/$(conversationId))
          );

        // Mesaj update
        allow update: if signedIn()
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
          && request.resource.data.senderId == resource.data.senderId
          && request.resource.data.type == resource.data.type
          && request.resource.data.createdAt == resource.data.createdAt
          && (
            !( "text" in resource.data ) || request.resource.data.text == resource.data.text
          )
          && (
            !( "imageUrl" in resource.data ) || request.resource.data.imageUrl == resource.data.imageUrl
          )
          && (
            !( "thumbnailUrl" in resource.data ) || request.resource.data.thumbnailUrl == resource.data.thumbnailUrl
          )
          && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["readAt","deleted","moderation"])
          && (
            !("deleted" in request.resource.data)
            || request.resource.data.deleted == resource.data.deleted
            || request.auth.uid == resource.data.senderId
            || isAdmin()
          )
          && (
            !("moderation" in request.resource.data)
            || isAdmin()
          );

        allow delete: if false;
      }
    }

    /* ========== DENY ALL ========== */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
